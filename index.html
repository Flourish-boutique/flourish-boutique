<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flourish Boutique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF0E0; /* A slightly more pronounced light orange background */
            color: #333333; /* Dark gray text */
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 80px; /* Space for the fixed header height */
            transition: padding-top 0.3s ease; /* Smooth transition for padding if header height changes */
        }
        main {
            flex-grow: 1;
        }
        .header-theme {
            background-color: #FF6347; /* Tomato - a vibrant orange */
            color: white;
            border-bottom: 1px solid #E0E0E0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed; /* Make the header fixed */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100; /* Ensure it stays on top */
            transition: transform 0.3s ease-out; /* Smooth slide transition */
            transform: translateY(0); /* Default visible state */
            height: 80px; /* Explicit height for the header */
            display: flex; /* Use flexbox for internal alignment */
            align-items: center; /* Vertically center content */
        }
        .header-hidden {
            transform: translateY(-100%); /* Slide up to hide */
        }
        .btn-primary {
            background-color: #FF8C00; /* DarkOrange */
            color: white;
            padding: 0.85rem 2rem;
            border-radius: 0.75rem; /* More rounded */
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .btn-primary:hover {
            background-color: #FF6347; /* Tomato */
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background-color: #FFA07A; /* LightSalmon - a lighter orange accent */
            color: #333333;
            padding: 0.85rem 2rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .btn-secondary:hover {
            background-color: #FF8C69; /* Darker LightSalmon */
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        .content-card, .modal-content-base {
            background-color: white;
            border-radius: 1.25rem; /* Even more rounded for a soft feel */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08); /* Soft, diffused shadow */
            padding: 2.5rem;
            margin-bottom: 3rem;
            border: 1px solid #F0F0F0; /* Very light border */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Slightly lighter overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content-base {
            padding: 3rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            transform: translateY(30px);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .modal-overlay.show .modal-content-base {
            transform: translateY(0);
            opacity: 1;
        }
        .close-button {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 2.25rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
        }
        .close-button:hover {
            color: #333;
        }
        /* Updated thank you message styling */
        .thank-you-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2.5rem 3.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: #22c55e; /* Green */
            font-weight: 700;
            text-align: center;
            font-size: 2.25rem; /* text-3xl */
            z-index: 1001; /* Above other modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out, transform 0.3s ease;
            display: flex; /* Use flexbox for centering content */
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .thank-you-message.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        .thank-you-message .fa-check-circle {
            font-size: 4rem; /* Large check icon */
            color: #22c55e;
            margin-bottom: 1rem;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #F5F5F5;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #FF8C00; /* DarkOrange scrollbar */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #FF6347;
        }

        /* Product card fade-in animation */
        .product-card {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.5s ease-out forwards;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 0.75rem; /* Further reduced padding for compactness */
            border: 1px solid #F3F4F6;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; /* For discount tag positioning */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push button to bottom */
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        @keyframes fadeInSlideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input field styling */
        input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="password"], textarea, select {
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.85rem 1.25rem;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="tel"]:focus, input[type="email"]:focus:focus, input[type="number"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #FF8C00; /* DarkOrange focus */
            box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.2); /* Orange glow */
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #FF8C00; /* Orange spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -280px; /* Hidden by default */
            width: 250px;
            height: 100%;
            background-color: #333; /* Dark background for menu */
            color: white;
            padding: 2rem 1rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            transition: left 0.3s ease-out;
            z-index: 999; /* Below modals, above main content */
            display: flex;
            flex-direction: column;
        }
        .hamburger-menu.open {
            left: 0;
        }
        .hamburger-menu ul {
            list-style: none;
            padding: 0;
            margin-top: 2rem;
            flex-grow: 1; /* Allow the list to grow and push admin button to bottom */
            display: flex;
            flex-direction: column;
        }
        .hamburger-menu ul li {
            margin-bottom: 1rem;
        }
        .hamburger-menu ul li a {
            display: block;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 1.125rem;
            font-weight: 500;
            text-decoration: none;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .hamburger-menu ul li a:hover {
            background-color: #555;
        }
        .hamburger-icon {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            background: transparent;
            border: none;
            padding: 0;
            z-index: 101; /* Above header content, but header is fixed */
            position: absolute; /* Position relative to header */
            left: 1.5rem; /* Adjust as needed */
            top: 50%;
            transform: translateY(-50%);
        }
        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }
        .hamburger-icon.open span:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }
        .hamburger-icon.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger-icon.open span:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }
        .menu-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        /* Carousel specific styles */
        #product-carousel {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth; /* Smooth scrolling for auto-swipe */
        }
        #product-carousel::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera*/
        }
        .carousel-product-card {
            flex: 0 0 auto; /* Do not grow, do not shrink, base on content */
            width: 180px; /* Further reduced width for carousel items */
            margin-right: 0.75rem; /* Reduced space between cards */
            scroll-snap-align: start;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.5s ease-out forwards;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 0.75rem; /* Reduced padding */
            border: 1px solid #F3F4F6;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; /* For discount tag positioning */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .carousel-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .carousel-product-card img {
            width: 100%;
            height: 120px; /* Reduced image height */
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem; /* Reduced margin */
        }

        /* Image Enlarge Modal Specific Styles */
        #imageEnlargeModal .modal-content-base {
            background-color: transparent; /* Transparent background for image modal */
            box-shadow: none; /* No shadow */
            padding: 0; /* No padding */
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 95%; /* Allow image to take more space */
            max-height: 95%;
        }
        #imageEnlargeModal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensure the whole image is visible */
            border-radius: 0.5rem; /* Rounded corners for the enlarged image */
        }
        #imageEnlargeModal .close-button {
            color: white; /* White close button for dark background */
            text-shadow: 0 0 5px rgba(0,0,0,0.5); /* Shadow to make it visible */
        }

        /* New Styles for Product Card Redesign */
        .product-image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            overflow: hidden;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .product-image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .discount-tag {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #EF4444; /* Red-500 */
            color: white;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem; /* text-xs */
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .original-price {
            text-decoration: line-through;
            color: #9CA3AF; /* Gray-400 */
            font-size: 0.875rem; /* text-sm */
            margin-right: 0.5rem;
        }
        .current-price {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            color: #FF8C00; /* DarkOrange */
        }
        .savings-text {
            font-size: 0.75rem; /* text-xs */
            color: #22C55E; /* Green-500 */
            font-weight: 600;
        }
        .sold-rating {
            display: flex;
            align-items: center;
            font-size: 0.75rem; /* text-xs */
            color: #6B7280; /* Gray-500 */
            margin-top: 0.25rem;
        }
        .sold-rating .fa-star, .sold-rating .fa-star-half-alt {
            color: #FBBF24; /* Amber-400 */
            margin-left: 0.25rem;
        }
        .sold-rating .far.fa-star { /* Style for empty stars */
            color: #D1D5DB; /* Light gray for empty stars */
            margin-left: 0.25rem;
        }
        .product-card .btn-primary, .carousel-product-card .btn-primary {
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 1rem; /* Smaller padding for button */
            margin-top: 0.75rem; /* Space above button */
        }
        .product-card h3, .carousel-product-card h3 {
            font-size: 1rem; /* text-base */
            font-weight: 600;
            color: #374151; /* Gray-700 */
            margin-bottom: 0.25rem;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
        }
        .product-card p.text-sm, .carousel-product-card p.text-sm {
            height: auto; /* Allow description to take full height */
            white-space: normal; /* Allow wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            line-height: 1.2; /* Adjust line height for compactness */
            margin-bottom: 0.5rem;
        }
        .product-card .quantity-input-container, .carousel-product-card .quantity-input-container {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .product-card .quantity-input-container input, .carousel-product-card .quantity-input-container input {
            width: 60px; /* Smaller quantity input */
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="scroll-smooth">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // Global Firebase variables
        let app;
        let db;
        let auth;
        let storage; // Declare storage
        let userId;
        let isAdmin = false; // Flag to determine if the current user is an admin
        let isAuthReady = false; // Flag to indicate if auth is ready
        let allProducts = []; // Store all products for filtering
        let allCategories = []; // Store all categories
        let appId; // Declare appId in global scope

        // Admin password (hardcoded for direct access)
        const ADMIN_PASSWORD = '1543zs03';

        // Current page state for SPA feel
        let currentPage = 'shop'; // 'shop', 'admin', 'edit'
        let activeCategoryFilter = 'All Products'; // Default filter

        // Cart
        let cart = {}; // { productId: { product, quantity } }

        // Carousel variables
        let carouselInterval;
        const CAROUSEL_SCROLL_INTERVAL = 3000; // 3 seconds
        const CAROUSEL_SCROLL_AMOUNT = 196; // Width of carousel card (180px) + margin-right (0.75rem = 12px) + some buffer

        // Initialize Firebase when the window loads
        window.onload = async function() {
            try {
                // Use Canvas environment variables if available
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyA_0KfaFfF0A5qeAL-yFC5keyWJFvW6UNs",
                    authDomain: "flourish-boutique.firebaseapp.com",
                    projectId: "flourish-boutique",
                    storageBucket: "flourish-boutique.firebasestorage.app",
                    messagingSenderId: "34816935044",
                    appId: "1:34816935044:web:d529f7e13d5fdbd08caed1",
                    measurementId: "G-D4EZM4MHF7"
                };

                appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId; // Prioritize __app_id

                // A more robust check to ensure the config is not empty or still using default placeholders
                if (!firebaseConfig.projectId || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_API_KEY")) {
                    console.error("Firebase config is incomplete or still contains placeholder values. Please update it.");
                    showModal('messageModal', 'Firebase configuration is not fully set up. Please ensure all values are correct in your HTML file.', 'text-red-600');
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Initialize storage

                // Display initial auth status message
                updateAuthStatusMessage('Initializing authentication...');

                // Authenticate user (for general data access, not admin login)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated user ID:", userId);
                        updateAuthStatusMessage(`Authenticated: ${userId.substring(0, 8)}...`);
                    } else {
                        try {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                                console.log("Signed in with custom token. User ID:", userId);
                                updateAuthStatusMessage(`Authenticated: ${userId.substring(0, 8)}...`);
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Signed in anonymously. User ID:", userId);
                                updateAuthStatusMessage(`Authenticated: ${userId.substring(0, 8)}... (Anonymous)`);
                            }
                        } catch (error) {
                            console.error("Error during anonymous sign-in or custom token sign-in:", error);
                            userId = crypto.randomUUID(); // Fallback to a random ID if auth fails
                            console.log("Using random user ID as fallback:", userId);
                            updateAuthStatusMessage('Authentication failed. Data access might be limited.', 'text-red-600');
                        }
                    }
                    isAuthReady = true; // Set auth ready flag
                    // Now that auth is ready, initialize Firestore listeners
                    initializeFirestoreListeners(); // No need to pass appId, it's global
                    renderPage(currentPage); // Render initial page after auth is ready
                });

                // Add event listeners for carousel auto-swipe pause/resume
                const carousel = document.getElementById('product-carousel');
                if (carousel) {
                    carousel.addEventListener('mouseover', stopAutoSwipe);
                    carousel.addEventListener('mouseout', startAutoSwipe);
                    carousel.addEventListener('touchstart', stopAutoSwipe); // For touch devices
                    carousel.addEventListener('touchend', startAutoSwipe); // For touch devices
                }

                // Initial cart load from localStorage
                loadCartFromLocalStorage();

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showModal('messageModal', 'Failed to initialize the application. Please try again later. Check your browser console for errors.', 'text-red-600');
                updateAuthStatusMessage('Firebase initialization failed!', 'text-red-600');
            }
        };

        // Function to update the auth status message in the UI
        function updateAuthStatusMessage(message, colorClass = 'text-gray-600') {
            const statusElement = document.getElementById('auth-status-message');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `text-center text-sm mt-2 ${colorClass}`;
            }
        }


        // --- Dynamic Header Scroll Logic ---
        let lastScrollY = 0;
        const header = document.querySelector('.header-theme');
        const headerHeight = 80; // Fixed height of the header
        const scrollHideThreshold = 100; // Scroll 100px down before hiding

        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;

            // Only apply dynamic hide/show if on the 'shop' page
            if (currentPage === 'shop') {
                if (currentScrollY > lastScrollY && currentScrollY > scrollHideThreshold) {
                    // Scrolling Down and past the threshold
                    header.classList.add('header-hidden');
                } else if (currentScrollY < lastScrollY || currentScrollY <= 0) {
                    // Scrolling Up or at the very top of the page
                    header.classList.remove('header-hidden');
                }
            } else {
                // Always show header in admin/edit mode
                header.classList.remove('header-hidden');
            }

            lastScrollY = currentScrollY;
        });


        // Function to initialize Firestore listeners after auth is ready
        function initializeFirestoreListeners() { // appId is now global
            if (!db) {
                console.error("Firestore DB is not initialized. Cannot set up listeners.");
                showModal('messageModal', 'Database not ready. Please refresh the page.', 'text-red-600');
                return;
            }
            // Ensure authentication is ready before setting up listeners
            if (!isAuthReady || !auth.currentUser) {
                console.warn("Authentication not ready or user is null. Delaying listener setup.");
                // We will re-attempt to set up listeners once onAuthStateChanged confirms a user.
                return;
            }

            // Log the appId being used for debugging
            console.log("AppId being used by Firestore listeners:", appId);
            updateAuthStatusMessage(`App ID: ${appId.substring(0, 8)}... (Auth: ${userId ? userId.substring(0,8) + '...' : 'N/A'})`, 'text-blue-600'); // Display AppId and User ID for verification


            // Listen for real-time updates to products
            const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
            onSnapshot(productsCollectionRef, (snapshot) => {
                allProducts = []; // Clear previous products
                snapshot.forEach(doc => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });
                console.log("Products updated by onSnapshot:", allProducts); // For debugging
                filterProducts(); // Display all products initially, or apply current filter
                renderCarouselProducts(allProducts); // Render products in the carousel
                displayEditableProducts(allProducts);
            }, (error) => {
                console.error("Error fetching products:", error);
                showModal('messageModal', `Error loading products: ${error.message}. Please refresh the page.`, 'text-red-600');
            });

            // Listen for real-time updates to orders (for admin panel)
            const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
            onSnapshot(ordersCollectionRef, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                displayOrders(orders);
                updateAdminDashboardStats(allProducts.length, orders.length);
            }, (error) => {
                console.error("Error fetching orders:", error);
                showModal('messageModal', `Error loading orders for admin: ${error.message}. Please refresh.`, 'text-red-600');
            });

            // Listen for real-time updates to categories
            const categoriesCollectionRef = collection(db, `artifacts/${appId}/public/data/categories`);
            onSnapshot(categoriesCollectionRef, (snapshot) => {
                allCategories = [];
                snapshot.forEach(doc => {
                    allCategories.push({ id: doc.id, ...doc.data() });
                });
                renderCategoryMenu(); // Update hamburger menu
                displayCategoriesForManagement(); // Update admin category list
                populateCategoryDropdowns(); // Update product forms
            }, (error) => {
                console.error("Error fetching categories:", error);
                showModal('messageModal', `Error loading categories: ${error.message}. Please refresh the page.`, 'text-red-600');
            });
        }

        // --- SPA Routing Logic ---
        window.renderPage = function(pageName) {
            currentPage = pageName;
            document.getElementById('hero-section').classList.add('hidden');
            document.getElementById('carousel-section').classList.add('hidden'); // Hide carousel section
            document.getElementById('products-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('edit-mode-panel').classList.add('hidden');

            // Ensure header is visible when changing pages, especially to admin/edit
            header.classList.remove('header-hidden');

            // Hide/show hamburger and shop now button based on page
            document.getElementById('hamburger-icon').classList.toggle('hidden', pageName !== 'shop');
            document.getElementById('shop-now-btn').classList.toggle('hidden', pageName !== 'shop');

            // Show/hide logout button based on isAdmin state
            document.getElementById('admin-logout-btn-container').classList.toggle('hidden', !isAdmin);


            if (pageName === 'shop') {
                document.getElementById('hero-section').classList.remove('hidden');
                document.getElementById('carousel-section').classList.remove('hidden'); // Show carousel section
                document.getElementById('products-section').classList.remove('hidden');
                document.getElementById('products-section').scrollIntoView({ behavior: 'smooth' });
                startAutoSwipe(); // Start auto-swipe when on shop page
            } else if (pageName === 'admin') {
                stopAutoSwipe(); // Stop auto-swipe when not on shop page
                // Only allow access if isAdmin is true
                if (!isAdmin) {
                    showModal('messageModal', 'Access Denied. Please log in as Admin.', 'text-red-600');
                    renderPage('shop'); // Redirect back to shop if not admin
                    return;
                }
                document.getElementById('admin-panel').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                updateAdminDashboardStats(allProducts.length, Object.keys(cart).length); // Update with actual order count
            } else if (pageName === 'edit') {
                stopAutoSwipe(); // Stop auto-swipe when not on shop page
                // Only allow access if isAdmin is true
                if (!isAdmin) {
                    showModal('messageModal', 'Access Denied. Please log in as Admin.', 'text-red-600');
                    renderPage('shop'); // Redirect back to shop if not admin
                    return;
                }
                document.getElementById('edit-mode-panel').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            closeHamburgerMenu(); // Close menu on page navigation
        }

        // --- Hamburger Menu Logic ---
        document.getElementById('hamburger-icon').addEventListener('click', () => {
            document.getElementById('hamburger-menu').classList.add('open');
            document.getElementById('hamburger-icon').classList.add('open');
        });

        document.getElementById('menu-close-button').addEventListener('click', closeHamburgerMenu);

        function closeHamburgerMenu() {
            document.getElementById('hamburger-menu').classList.remove('open');
            document.getElementById('hamburger-icon').classList.remove('open');
        }

        function renderCategoryMenu() {
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = ''; // Clear existing categories

            // Add 'All Products' option
            const allProductsItem = document.createElement('li');
            const allProductsLink = document.createElement('a');
            allProductsLink.href = "#";
            allProductsLink.textContent = "All Products";
            allProductsLink.className = "block px-4 py-2 text-white font-semibold hover:bg-gray-700 rounded-lg transition-colors";
            allProductsLink.addEventListener('click', () => {
                setActiveCategoryFilter('All Products');
                closeHamburgerMenu();
            });
            allProductsItem.appendChild(allProductsLink);
            categoryList.appendChild(allProductsItem);


            allCategories.forEach(category => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = "#";
                link.textContent = category.name;
                link.className = "block px-4 py-2 text-white font-semibold hover:bg-gray-700 rounded-lg transition-colors";
                link.addEventListener('click', () => {
                    setActiveCategoryFilter(category.name);
                    closeHamburgerMenu();
                });
                listItem.appendChild(link);
                categoryList.appendChild(listItem);
            });
        }

        function setActiveCategoryFilter(categoryName) {
            activeCategoryFilter = categoryName;
            filterProducts(); // Re-render products based on the new filter
            document.getElementById('current-category-display').textContent = categoryName;
            document.getElementById('products-section').scrollIntoView({ behavior: 'smooth' });
        }


        // --- Product Rendering Logic ---
        function renderStars(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += '<i class="fas fa-star text-amber-400"></i>';
                } else if (i - 0.5 === rating) {
                    starsHtml += '<i class="fas fa-star-half-alt text-amber-400"></i>';
                } else {
                    starsHtml += '<i class="far fa-star text-gray-300"></i>';
                }
            }
            return starsHtml;
        }

        function filterProducts() {
            const productsContainer = document.getElementById('products-container');
            productsContainer.innerHTML = ''; // Clear existing products

            const filtered = activeCategoryFilter === 'All Products'
                ? allProducts
                : allProducts.filter(p => p.category === activeCategoryFilter);

            if (filtered.length === 0) {
                productsContainer.innerHTML = `<p class="text-center text-lg text-gray-600 col-span-full">No products found in "${activeCategoryFilter}" category.</p>`;
                return;
            }

            filtered.forEach((product, index) => {
                const discount = product.discountPercentage ? product.discountPercentage : 0;
                const originalPrice = product.price;
                const currentPrice = originalPrice * (1 - discount / 100);
                const savings = originalPrice - currentPrice;

                const productCard = document.createElement('div');
                productCard.className = `product-card animate-fadeInSlideUp delay-${index * 100} ease-out forwards flex flex-col`; // Added flex-col
                productCard.style.animationDelay = `${index * 0.05}s`; // Stagger animation

                productCard.innerHTML = `
                    <div class="product-image-container cursor-pointer" data-product-id="${product.id}">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/200'}" alt="${product.name}" class="rounded-lg mb-2">
                        ${discount > 0 ? `<span class="discount-tag">-${discount}%</span>` : ''}
                    </div>
                    <div class="flex-grow flex flex-col justify-between p-2"> <h3 class="text-base font-semibold text-gray-800 mb-1 leading-tight">${product.name}</h3>
                        <p class="text-sm text-gray-600 mb-2 overflow-hidden text-ellipsis whitespace-normal line-clamp-2">${product.description}</p>
                        <div class="flex items-center mb-1">
                            ${discount > 0 ? `<span class="original-price text-gray-500 text-xs">$${originalPrice.toFixed(2)}</span>` : ''}
                            <span class="current-price text-orange-600 font-bold text-lg">$${currentPrice.toFixed(2)}</span>
                        </div>
                        ${discount > 0 ? `<p class="savings-text text-green-600 text-xs mb-1">Save $${savings.toFixed(2)}</p>` : ''}
                        <div class="sold-rating flex items-center text-gray-500 text-xs">
                            <span>${product.sold} sold</span>
                            <span class="ml-2">${renderStars(product.rating)}</span>
                            <span class="ml-1">(${product.reviews})</span>
                        </div>
                        <div class="quantity-input-container flex items-center justify-center mt-3 mb-2">
                            <button class="quantity-btn bg-gray-200 text-gray-700 px-2 py-1 rounded-l-md hover:bg-gray-300 transition" data-action="decrease" data-product-id="${product.id}">-</button>
                            <input type="number" class="quantity-input w-16 text-center border-t border-b border-gray-300 py-1 text-sm" value="${cart[product.id] ? cart[product.id].quantity : 1}" min="1" data-product-id="${product.id}">
                            <button class="quantity-btn bg-gray-200 text-gray-700 px-2 py-1 rounded-r-md hover:bg-gray-300 transition" data-action="increase" data-product-id="${product.id}">+</button>
                        </div>
                        <button class="btn-primary w-full add-to-cart-btn" data-product-id="${product.id}">Add to Cart</button>
                    </div>
                `;
                productsContainer.appendChild(productCard);
            });

            // Add event listeners for quantity buttons and inputs
            productsContainer.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const input = productsContainer.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    let quantity = parseInt(input.value);
                    if (event.target.dataset.action === 'increase') {
                        quantity++;
                    } else if (event.target.dataset.action === 'decrease' && quantity > 1) {
                        quantity--;
                    }
                    input.value = quantity;
                });
            });

            productsContainer.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (event) => {
                    let quantity = parseInt(event.target.value);
                    if (isNaN(quantity) || quantity < 1) {
                        event.target.value = 1;
                    }
                });
            });

            // Add event listeners for Add to Cart buttons
            productsContainer.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const quantityInput = productsContainer.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseInt(quantityInput.value);
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        addToCart(product, quantity);
                        showToast('Product added to cart!', 'success');
                    }
                });
            });

            // Add event listeners for image enlarge
            productsContainer.querySelectorAll('.product-image-container img').forEach(img => {
                img.addEventListener('click', (event) => {
                    const productId = event.target.closest('.product-image-container').dataset.productId;
                    const product = allProducts.find(p => p.id === productId);
                    if (product && product.imageUrl) {
                        showImageEnlargeModal(product.imageUrl, product.name);
                    }
                });
            });
        }


        // --- Product Carousel Logic ---
        function renderCarouselProducts(products) {
            const carouselContainer = document.getElementById('product-carousel');
            carouselContainer.innerHTML = ''; // Clear existing products

            const featuredProducts = products.sort(() => 0.5 - Math.random()).slice(0, 8); // Get 8 random products

            if (featuredProducts.length === 0) {
                carouselContainer.innerHTML = `<p class="text-center text-lg text-gray-600 col-span-full">No products available for carousel.</p>`;
                return;
            }

            featuredProducts.forEach((product, index) => {
                const discount = product.discountPercentage ? product.discountPercentage : 0;
                const originalPrice = product.price;
                const currentPrice = originalPrice * (1 - discount / 100);

                const carouselProductCard = document.createElement('div');
                carouselProductCard.className = `carousel-product-card animate-fadeInSlideUp delay-${index * 100} ease-out forwards flex flex-col`;
                carouselProductCard.style.animationDelay = `${index * 0.05}s`;

                carouselProductCard.innerHTML = `
                    <div class="product-image-container cursor-pointer" data-product-id="${product.id}">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/200'}" alt="${product.name}" class="rounded-lg mb-2">
                        ${discount > 0 ? `<span class="discount-tag">-${discount}%</span>` : ''}
                    </div>
                    <div class="flex-grow flex flex-col justify-between p-1"> <h3 class="text-sm font-semibold text-gray-800 mb-1 leading-tight">${product.name}</h3>
                        <p class="text-xs text-gray-600 mb-1 overflow-hidden text-ellipsis whitespace-normal line-clamp-2">${product.description}</p>
                        <div class="flex items-center mb-1">
                            ${discount > 0 ? `<span class="original-price text-gray-500 text-xs">$${originalPrice.toFixed(2)}</span>` : ''}
                            <span class="current-price text-orange-600 font-bold text-base">$${currentPrice.toFixed(2)}</span>
                        </div>
                        <div class="sold-rating flex items-center text-gray-500 text-xs">
                            <span>${product.sold} sold</span>
                            <span class="ml-1">${renderStars(product.rating)}</span>
                        </div>
                        <div class="quantity-input-container flex items-center justify-center mt-2 mb-1">
                            <button class="quantity-btn bg-gray-200 text-gray-700 px-1 py-0.5 rounded-l-md hover:bg-gray-300 transition text-xs" data-action="decrease" data-product-id="${product.id}">-</button>
                            <input type="number" class="quantity-input w-12 text-center border-t border-b border-gray-300 py-0.5 text-xs" value="${cart[product.id] ? cart[product.id].quantity : 1}" min="1" data-product-id="${product.id}">
                            <button class="quantity-btn bg-gray-200 text-gray-700 px-1 py-0.5 rounded-r-md hover:bg-gray-300 transition text-xs" data-action="increase" data-product-id="${product.id}">+</button>
                        </div>
                        <button class="btn-primary w-full add-to-cart-btn text-xs px-2 py-1 mt-2" data-product-id="${product.id}">Add to Cart</button>
                    </div>
                `;
                carouselContainer.appendChild(carouselProductCard);
            });

            // Add event listeners for quantity buttons and inputs for carousel
            carouselContainer.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const input = carouselContainer.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    let quantity = parseInt(input.value);
                    if (event.target.dataset.action === 'increase') {
                        quantity++;
                    } else if (event.target.dataset.action === 'decrease' && quantity > 1) {
                        quantity--;
                    }
                    input.value = quantity;
                });
            });

            carouselContainer.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (event) => {
                    let quantity = parseInt(event.target.value);
                    if (isNaN(quantity) || quantity < 1) {
                        event.target.value = 1;
                    }
                });
            });

            // Add event listeners for Add to Cart buttons for carousel
            carouselContainer.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.target.dataset.productId;
                    const quantityInput = carouselContainer.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseInt(quantityInput.value);
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        addToCart(product, quantity);
                        showToast('Product added to cart!', 'success');
                    }
                });
            });

            // Add event listeners for image enlarge in carousel
            carouselContainer.querySelectorAll('.product-image-container img').forEach(img => {
                img.addEventListener('click', (event) => {
                    const productId = event.target.closest('.product-image-container').dataset.productId;
                    const product = allProducts.find(p => p.id === productId);
                    if (product && product.imageUrl) {
                        showImageEnlargeModal(product.imageUrl, product.name);
                    }
                });
            });
        }


        function startAutoSwipe() {
            stopAutoSwipe(); // Clear any existing interval
            const carousel = document.getElementById('product-carousel');
            if (carousel) {
                carouselInterval = setInterval(() => {
                    if (carousel.scrollWidth - carousel.scrollLeft <= carousel.clientWidth + 1) { // +1 for tolerance
                        carousel.scrollTo({ left: 0, behavior: 'smooth' });
                    } else {
                        carousel.scrollBy({ left: CAROUSEL_SCROLL_AMOUNT, behavior: 'smooth' });
                    }
                }, CAROUSEL_SCROLL_INTERVAL);
            }
        }

        function stopAutoSwipe() {
            clearInterval(carouselInterval);
        }

        // Add event listeners for carousel navigation buttons
        document.getElementById('carousel-prev')?.addEventListener('click', () => {
            document.getElementById('product-carousel').scrollBy({ left: -CAROUSEL_SCROLL_AMOUNT, behavior: 'smooth' });
        });

        document.getElementById('carousel-next')?.addEventListener('click', () => {
            document.getElementById('product-carousel').scrollBy({ left: CAROUSEL_SCROLL_AMOUNT, behavior: 'smooth' });
        });


        // --- Cart Functionality ---
        function loadCartFromLocalStorage() {
            const storedCart = localStorage.getItem('flourishCart');
            if (storedCart) {
                cart = JSON.parse(storedCart);
                updateCartDisplay();
            }
        }

        function saveCartToLocalStorage() {
            localStorage.setItem('flourishCart', JSON.stringify(cart));
        }

        function addToCart(product, quantity = 1) {
            if (cart[product.id]) {
                cart[product.id].quantity += quantity;
            } else {
                cart[product.id] = { ...product, quantity: quantity };
            }
            updateCartDisplay();
            saveCartToLocalStorage();
        }

        function removeFromCart(productId) {
            delete cart[productId];
            updateCartDisplay();
            saveCartToLocalStorage();
        }

        function updateCartItemQuantity(productId, newQuantity) {
            if (cart[productId]) {
                cart[productId].quantity = newQuantity;
                if (cart[productId].quantity <= 0) {
                    removeFromCart(productId);
                }
            }
            updateCartDisplay();
            saveCartToLocalStorage();
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');
            const cartCountElement = document.getElementById('cart-count');
            let total = 0;
            let itemCount = 0;

            cartItemsContainer.innerHTML = ''; // Clear previous items

            for (const productId in cart) {
                const item = cart[productId];
                const itemTotal = (item.price * (1 - (item.discountPercentage || 0) / 100)) * item.quantity;
                total += itemTotal;
                itemCount += item.quantity;

                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'flex items-center justify-between py-2 border-b border-gray-200';
                cartItemDiv.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <img src="${item.imageUrl || 'https://via.placeholder.com/50'}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">${item.name}</h4>
                            <p class="text-sm text-gray-600">$${(item.price * (1 - (item.discountPercentage || 0) / 100)).toFixed(2)} x ${item.quantity}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="number" class="w-16 text-center border border-gray-300 rounded-md py-1 text-sm" value="${item.quantity}" min="1" data-product-id="${item.id}" onchange="updateCartItemQuantity(this.dataset.productId, parseInt(this.value))">
                        <button class="ml-2 text-red-500 hover:text-red-700 transition" onclick="removeFromCart('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItemDiv);
            }

            cartTotalElement.textContent = `$${total.toFixed(2)}`;
            cartCountElement.textContent = itemCount;
            document.getElementById('cart-badge').classList.toggle('hidden', itemCount === 0);
        }

        document.getElementById('view-cart-btn').addEventListener('click', () => {
            showModal('cartModal');
            updateCartDisplay(); // Ensure cart display is fresh
        });

        document.getElementById('checkout-btn').addEventListener('click', () => {
            if (Object.keys(cart).length === 0) {
                showModal('messageModal', 'Your cart is empty. Please add some products before checking out.', 'text-red-600');
                return;
            }
            closeModal('cartModal'); // Close cart modal
            showModal('checkoutModal');
        });

        document.getElementById('checkout-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const name = form.elements['customer-name'].value;
            const email = form.elements['customer-email'].value;
            const address = form.elements['customer-address'].value;
            const phone = form.elements['customer-phone'].value;

            if (!name || !email || !address || !phone) {
                showToast('Please fill in all contact details.', 'error');
                return;
            }

            const orderItems = Object.values(cart).map(item => ({
                productId: item.id,
                name: item.name,
                quantity: item.quantity,
                pricePerUnit: item.price * (1 - (item.discountPercentage || 0) / 100),
                imageUrl: item.imageUrl
            }));

            const orderTotal = orderItems.reduce((sum, item) => sum + (item.quantity * item.pricePerUnit), 0);

            const order = {
                customerId: userId,
                customerName: name,
                customerEmail: email,
                customerAddress: address,
                customerPhone: phone,
                items: orderItems,
                total: orderTotal,
                orderDate: new Date(),
                status: 'Pending'
            };

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner"></span> Processing...`;

            try {
                // Use a transaction to ensure atomicity for order creation and stock update
                await runTransaction(db, async (transaction) => {
                    const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
                    const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);

                    // Add the order
                    transaction.set(doc(ordersCollectionRef), order);

                    // Update product stock (simplified - assuming 'stock' field exists)
                    for (const item of orderItems) {
                        const productRef = doc(productsCollectionRef, item.productId);
                        const productDoc = await transaction.get(productRef);

                        if (!productDoc.exists()) {
                            throw new Error(`Product ${item.name} not found!`);
                        }

                        const currentStock = productDoc.data().stock || 0;
                        if (currentStock < item.quantity) {
                            throw new Error(`Not enough stock for ${item.name}. Available: ${currentStock}`);
                        }
                        transaction.update(productRef, {
                            stock: currentStock - item.quantity,
                            sold: (productDoc.data().sold || 0) + item.quantity // Increment sold count
                        });
                    }
                });

                showThankYouMessage();
                closeModal('checkoutModal');
                cart = {}; // Clear cart after successful order
                saveCartToLocalStorage();
                updateCartDisplay();
                form.reset(); // Clear form fields
            } catch (error) {
                console.error("Error submitting order:", error);
                showToast(`Order failed: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `Place Order`;
            }
        });

        function showThankYouMessage() {
            const thankYou = document.getElementById('thankYouMessage');
            thankYou.classList.add('show');
            setTimeout(() => {
                thankYou.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // --- Image Enlarge Modal ---
        function showImageEnlargeModal(imageUrl, altText) {
            const modal = document.getElementById('imageEnlargeModal');
            const imgElement = modal.querySelector('img');
            imgElement.src = imageUrl;
            imgElement.alt = altText;
            modal.classList.add('show');
        }


        // --- Modals Logic (General) ---
        function showModal(modalId, message = '', messageType = 'text-gray-800') {
            const modal = document.getElementById(modalId);
            if (modalId === 'messageModal') {
                const messageElement = modal.querySelector('#messageModalContent p');
                if (messageElement) {
                    messageElement.textContent = message;
                    messageElement.className = messageType; // Apply dynamic color
                }
            }
            modal.classList.add('show');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
        }

        // Attach event listeners to close buttons
        document.querySelectorAll('.modal-overlay .close-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const modalId = event.target.closest('.modal-overlay').id;
                closeModal(modalId);
            });
        });

        // Close modal when clicking outside content
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    closeModal(overlay.id);
                }
            });
        });

        // --- Toast Notification ---
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white transform translate-y-full opacity-0 transition-all duration-300 ease-out z-[1002]`;

            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-blue-500');
            }

            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-full', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // --- Admin Panel Logic ---
        document.getElementById('admin-login-btn').addEventListener('click', () => {
            showModal('adminLoginModal');
        });

        document.getElementById('admin-logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                isAdmin = false;
                showToast('Logged out from admin.', 'info');
                renderPage('shop'); // Redirect to shop page after logout
                updateAuthStatusMessage('Signed out. Authenticated anonymously.');
            } catch (error) {
                console.error("Error logging out:", error);
                showToast('Error logging out.', 'error');
            }
        });

        document.getElementById('admin-login-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput.value;
            const submitButton = event.target.querySelector('button[type="submit"]');

            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner"></span> Logging in...`;

            if (password === ADMIN_PASSWORD) {
                try {
                    // Sign in anonymously if not already, then proceed as admin
                    if (!auth.currentUser || auth.currentUser.isAnonymous) {
                         // We are already signing in anonymously on load, so we just set isAdmin here
                         isAdmin = true;
                    } else {
                        // If a non-anonymous user is signed in, we might need a custom token flow for proper admin auth
                        // For this simplified example, we'll just set isAdmin.
                        isAdmin = true;
                    }
                    closeModal('adminLoginModal');
                    renderPage('admin'); // Navigate to admin panel
                    showToast('Admin access granted!', 'success');
                } catch (error) {
                    console.error("Admin login error:", error);
                    showToast('Authentication failed during admin login.', 'error');
                    isAdmin = false; // Ensure isAdmin is false on error
                }
            } else {
                showToast('Incorrect password.', 'error');
                isAdmin = false;
            }
            passwordInput.value = ''; // Clear password field
            submitButton.disabled = false;
            submitButton.innerHTML = `Login`;
        });

        // --- Admin Dashboard Stats ---
        function updateAdminDashboardStats(productCount, orderCount) {
            document.getElementById('dashboard-product-count').textContent = productCount;
            document.getElementById('dashboard-order-count').textContent = orderCount;
        }

        // --- Admin Product Management ---
        let currentEditingProduct = null;

        async function displayEditableProducts(products) {
            const productListDiv = document.getElementById('admin-product-list');
            productListDiv.innerHTML = '';

            if (products.length === 0) {
                productListDiv.innerHTML = '<p class="text-gray-600">No products to manage. Add a new product!</p>';
                return;
            }

            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'flex items-center justify-between bg-white p-4 rounded-lg shadow-sm mb-4 border border-gray-200';
                productDiv.innerHTML = `
                    <div class="flex items-center">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/60'}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md mr-4">
                        <div>
                            <h4 class="font-semibold text-lg text-gray-800">${product.name}</h4>
                            <p class="text-gray-600 text-sm">$${product.price.toFixed(2)} | Stock: ${product.stock || 0}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn-secondary px-3 py-1 text-sm" onclick="editProduct('${product.id}')">Edit</button>
                        <button class="bg-red-500 text-white px-3 py-1 text-sm rounded-md hover:bg-red-600 transition" onclick="confirmDeleteProduct('${product.id}', '${product.name}', '${product.imageUrl}')">Delete</button>
                    </div>
                `;
                productListDiv.appendChild(productDiv);
            });
        }

        async function addProduct() {
            currentEditingProduct = null;
            document.getElementById('product-form-title').textContent = 'Add New Product';
            document.getElementById('product-id-field').value = ''; // Clear product ID
            document.getElementById('product-form').reset();
            document.getElementById('current-image-preview').src = 'https://via.placeholder.com/100'; // Placeholder
            document.getElementById('current-image-preview').classList.remove('hidden');
            document.getElementById('image-upload-label').textContent = 'Upload Image';
            document.getElementById('product-image').value = ''; // Clear file input
            populateCategoryDropdowns();
            showModal('productModal');
        }

        async function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                currentEditingProduct = product;
                document.getElementById('product-form-title').textContent = 'Edit Product';
                document.getElementById('product-id-field').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock || 0;
                document.getElementById('product-discount-percentage').value = product.discountPercentage || 0;
                document.getElementById('product-rating').value = product.rating || 0;
                document.getElementById('product-reviews').value = product.reviews || 0;
                document.getElementById('product-sold').value = product.sold || 0;
                document.getElementById('product-category').value = product.category || '';

                if (product.imageUrl) {
                    document.getElementById('current-image-preview').src = product.imageUrl;
                    document.getElementById('current-image-preview').classList.remove('hidden');
                    document.getElementById('image-upload-label').textContent = 'Change Image';
                } else {
                    document.getElementById('current-image-preview').src = 'https://via.placeholder.com/100';
                    document.getElementById('image-upload-label').textContent = 'Upload Image';
                }
                document.getElementById('product-image').value = ''; // Clear file input

                populateCategoryDropdowns();
                showModal('productModal');
            } else {
                showToast('Product not found for editing.', 'error');
            }
        }

        async function saveProduct(event) {
            event.preventDefault();
            const form = event.target;
            const productId = document.getElementById('product-id-field').value;
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const discountPercentage = parseFloat(document.getElementById('product-discount-percentage').value);
            const rating = parseFloat(document.getElementById('product-rating').value);
            const reviews = parseInt(document.getElementById('product-reviews').value);
            const sold = parseInt(document.getElementById('product-sold').value);
            const category = document.getElementById('product-category').value;
            const imageFile = document.getElementById('product-image').files[0];

            if (!name || !description || isNaN(price) || isNaN(stock) || isNaN(discountPercentage) || isNaN(rating) || isNaN(reviews) || isNaN(sold) || !category) {
                showToast('Please fill all product fields correctly.', 'error');
                return;
            }

            if (price <= 0 || stock < 0 || discountPercentage < 0 || discountPercentage > 100 || rating < 0 || rating > 5 || reviews < 0 || sold < 0) {
                 showToast('Please enter valid positive numbers for price, stock, discount, rating, reviews, and sold. Discount must be between 0 and 100, rating between 0 and 5.', 'error');
                 return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner"></span> Saving...`;

            let imageUrl = currentEditingProduct ? currentEditingProduct.imageUrl : '';

            try {
                if (imageFile) {
                    // Upload new image
                    const imageRef = ref(storage, `artifacts/${appId}/product_images/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(imageRef, imageFile);
                    imageUrl = await getDownloadURL(snapshot.ref);

                    // If editing and previous image existed, delete old image
                    if (currentEditingProduct && currentEditingProduct.imageUrl) {
                        try {
                            const oldImageRef = ref(storage, currentEditingProduct.imageUrl);
                            await deleteObject(oldImageRef);
                            console.log("Old image deleted successfully.");
                        } catch (error) {
                            console.warn("Could not delete old image (might not exist or different path):", error);
                        }
                    }
                }

                const productData = {
                    name,
                    description,
                    price,
                    stock,
                    discountPercentage,
                    rating,
                    reviews,
                    sold,
                    category,
                    imageUrl
                };

                if (productId) {
                    // Update existing product
                    const productRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
                    await updateDoc(productRef, productData);
                    showToast('Product updated successfully!', 'success');
                } else {
                    // Add new product
                    const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
                    await addDoc(productsCollectionRef, productData);
                    showToast('Product added successfully!', 'success');
                }
                closeModal('productModal');
            } catch (error) {
                console.error("Error saving product:", error);
                showToast(`Failed to save product: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = currentEditingProduct ? 'Update Product' : 'Add Product';
            }
        }

        let productToDelete = null;
        let productToDeleteImage = null;

        function confirmDeleteProduct(id, name, imageUrl) {
            productToDelete = id;
            productToDeleteImage = imageUrl;
            showModal('confirmDeleteProductModal');
            document.getElementById('product-to-delete-name').textContent = name;
        }

        async function deleteProductConfirmed() {
            if (!productToDelete) return;

            const deleteButton = document.getElementById('confirm-delete-product-btn');
            deleteButton.disabled = true;
            deleteButton.innerHTML = `<span class="spinner"></span> Deleting...`;

            try {
                // Delete image from storage if it exists
                if (productToDeleteImage) {
                    try {
                        const imageRef = ref(storage, productToDeleteImage);
                        await deleteObject(imageRef);
                        console.log("Product image deleted from storage.");
                    } catch (error) {
                        console.warn("Could not delete product image from storage (might not exist):", error);
                    }
                }

                // Delete document from Firestore
                const productRef = doc(db, `artifacts/${appId}/public/data/products`, productToDelete);
                await deleteDoc(productRef);
                showToast('Product deleted successfully!', 'success');
                closeModal('confirmDeleteProductModal');
                productToDelete = null;
                productToDeleteImage = null;
            } catch (error) {
                console.error("Error deleting product:", error);
                showToast(`Failed to delete product: ${error.message}`, 'error');
            } finally {
                deleteButton.disabled = false;
                deleteButton.innerHTML = `Yes, Delete`;
            }
        }


        // --- Admin Category Management ---
        let currentEditingCategory = null;

        function displayCategoriesForManagement() {
            const categoryListDiv = document.getElementById('admin-category-list');
            categoryListDiv.innerHTML = '';

            if (allCategories.length === 0) {
                categoryListDiv.innerHTML = '<p class="text-gray-600">No categories defined yet.</p>';
                return;
            }

            allCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex items-center justify-between bg-white p-3 rounded-lg shadow-sm mb-3 border border-gray-200';
                categoryDiv.innerHTML = `
                    <h4 class="font-semibold text-lg text-gray-800">${category.name}</h4>
                    <div class="flex space-x-2">
                        <button class="btn-secondary px-3 py-1 text-sm" onclick="editCategory('${category.id}')">Edit</button>
                        <button class="bg-red-500 text-white px-3 py-1 text-sm rounded-md hover:bg-red-600 transition" onclick="confirmDeleteCategory('${category.id}', '${category.name}')">Delete</button>
                    </div>
                `;
                categoryListDiv.appendChild(categoryDiv);
            });
        }

        function addCategory() {
            currentEditingCategory = null;
            document.getElementById('category-form-title').textContent = 'Add New Category';
            document.getElementById('category-id-field').value = '';
            document.getElementById('category-name').value = '';
            showModal('categoryModal');
        }

        function editCategory(categoryId) {
            const category = allCategories.find(c => c.id === categoryId);
            if (category) {
                currentEditingCategory = category;
                document.getElementById('category-form-title').textContent = 'Edit Category';
                document.getElementById('category-id-field').value = category.id;
                document.getElementById('category-name').value = category.name;
                showModal('categoryModal');
            } else {
                showToast('Category not found for editing.', 'error');
            }
        }

        async function saveCategory(event) {
            event.preventDefault();
            const form = event.target;
            const categoryId = document.getElementById('category-id-field').value;
            const name = document.getElementById('category-name').value.trim();

            if (!name) {
                showToast('Category name cannot be empty.', 'error');
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner"></span> Saving...`;

            try {
                if (categoryId) {
                    // Update existing category
                    const categoryRef = doc(db, `artifacts/${appId}/public/data/categories`, categoryId);
                    await updateDoc(categoryRef, { name });
                    showToast('Category updated successfully!', 'success');
                } else {
                    // Add new category
                    const categoriesCollectionRef = collection(db, `artifacts/${appId}/public/data/categories`);
                    await addDoc(categoriesCollectionRef, { name });
                    showToast('Category added successfully!', 'success');
                }
                closeModal('categoryModal');
            } catch (error) {
                console.error("Error saving category:", error);
                showToast(`Failed to save category: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = currentEditingCategory ? 'Update Category' : 'Add Category';
            }
        }

        let categoryToDelete = null;
        function confirmDeleteCategory(id, name) {
            categoryToDelete = id;
            showModal('confirmDeleteCategoryModal');
            document.getElementById('category-to-delete-name').textContent = name;
        }

        async function deleteCategoryConfirmed() {
            if (!categoryToDelete) return;

            const deleteButton = document.getElementById('confirm-delete-category-btn');
            deleteButton.disabled = true;
            deleteButton.innerHTML = `<span class="spinner"></span> Deleting...`;

            try {
                const categoryRef = doc(db, `artifacts/${appId}/public/data/categories`, categoryToDelete);
                await deleteDoc(categoryRef);
                showToast('Category deleted successfully!', 'success');
                closeModal('confirmDeleteCategoryModal');
                categoryToDelete = null;
            } catch (error) {
                console.error("Error deleting category:", error);
                showToast(`Failed to delete category: ${error.message}`, 'error');
            } finally {
                deleteButton.disabled = false;
                deleteButton.innerHTML = `Yes, Delete`;
            }
        }

        // Populate category dropdowns in product forms
        function populateCategoryDropdowns() {
            const productCategoryDropdown = document.getElementById('product-category');
            productCategoryDropdown.innerHTML = '<option value="">Select Category</option>'; // Default option

            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                productCategoryDropdown.appendChild(option);
            });

            // If editing a product, re-select its category
            if (currentEditingProduct && currentEditingProduct.category) {
                productCategoryDropdown.value = currentEditingProduct.category;
            }
        }

        // --- Admin Order Management ---
        function displayOrders(orders) {
            const ordersTableBody = document.getElementById('admin-orders-table-body');
            ordersTableBody.innerHTML = '';

            if (orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-600">No orders placed yet.</td></tr>';
                return;
            }

            orders.sort((a, b) => b.orderDate.toDate() - a.orderDate.toDate()); // Sort by newest first

            orders.forEach(order => {
                const orderDate = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleString() : 'N/A';
                const itemsList = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id.substring(0, 6)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${order.customerName}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">${itemsList}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">$${order.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                        <span class="${order.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                            ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="viewOrderDetails('${order.id}')">View</button>
                        ${order.status !== 'Completed' ? `<button class="text-green-600 hover:text-green-900 mr-2" onclick="markOrderCompleted('${order.id}')">Complete</button>` : ''}
                        <button class="text-red-600 hover:text-red-900" onclick="confirmDeleteOrder('${order.id}')">Delete</button>
                    </td>
                `;
                ordersTableBody.appendChild(row);
            });
        }

        async function viewOrderDetails(orderId) {
            const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (orderDoc.exists()) {
                    const order = orderDoc.data();
                    const orderDate = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleString() : 'N/A';
                    let itemsHtml = '';
                    order.items.forEach(item => {
                        itemsHtml += `<li class="mb-2">
                                        <div class="flex items-center">
                                            <img src="${item.imageUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 object-cover rounded-md mr-3" />
                                            <span>${item.name} (x${item.quantity}) - $${(item.pricePerUnit * item.quantity).toFixed(2)}</span>
                                        </div>
                                      </li>`;
                    });

                    const modalContent = document.getElementById('order-details-content');
                    modalContent.innerHTML = `
                        <p><strong>Order ID:</strong> ${orderId}</p>
                        <p><strong>Customer Name:</strong> ${order.customerName}</p>
                        <p><strong>Email:</strong> ${order.customerEmail}</p>
                        <p><strong>Address:</strong> ${order.customerAddress}</p>
                        <p><strong>Phone:</strong> ${order.customerPhone}</p>
                        <p><strong>Order Date:</strong> ${orderDate}</p>
                        <p><strong>Status:</strong> <span class="${order.status === 'Completed' ? 'text-green-600' : 'text-yellow-600'} font-semibold">${order.status}</span></p>
                        <h4 class="font-semibold text-lg mt-4 mb-2">Items:</h4>
                        <ul class="list-disc pl-5">${itemsHtml}</ul>
                        <p class="font-bold text-xl mt-4">Total: $${order.total.toFixed(2)}</p>
                    `;
                    showModal('orderDetailsModal');
                } else {
                    showToast('Order details not found.', 'error');
                }
            } catch (error) {
                console.error("Error fetching order details:", error);
                showToast(`Error viewing order: ${error.message}`, 'error');
            }
        }

        async function markOrderCompleted(orderId) {
            const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
            try {
                await updateDoc(orderRef, { status: 'Completed' });
                showToast('Order marked as completed!', 'success');
            } catch (error) {
                console.error("Error marking order complete:", error);
                showToast(`Failed to mark order complete: ${error.message}`, 'error');
            }
        }

        let orderToDelete = null;
        function confirmDeleteOrder(orderId) {
            orderToDelete = orderId;
            showModal('confirmDeleteOrderModal');
        }

        async function deleteOrderConfirmed() {
            if (!orderToDelete) return;

            const deleteButton = document.getElementById('confirm-delete-order-btn');
            deleteButton.disabled = true;
            deleteButton.innerHTML = `<span class="spinner"></span> Deleting...`;

            try {
                const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderToDelete);
                await deleteDoc(orderRef);
                showToast('Order deleted successfully!', 'success');
                closeModal('confirmDeleteOrderModal');
                orderToDelete = null;
            } catch (error) {
                console.error("Error deleting order:", error);
                showToast(`Failed to delete order: ${error.message}`, 'error');
            } finally {
                deleteButton.disabled = false;
                deleteButton.innerHTML = `Yes, Delete`;
            }
        }

        // --- Event Listeners for Admin Tabs ---
        document.getElementById('show-products').addEventListener('click', () => {
            document.getElementById('admin-product-management').classList.remove('hidden');
            document.getElementById('admin-category-management').classList.add('hidden');
            document.getElementById('admin-order-management').classList.add('hidden');
            document.getElementById('admin-dashboard-overview').classList.add('hidden');
        });

        document.getElementById('show-categories').addEventListener('click', () => {
            document.getElementById('admin-product-management').classList.add('hidden');
            document.getElementById('admin-category-management').classList.remove('hidden');
            document.getElementById('admin-order-management').classList.add('hidden');
            document.getElementById('admin-dashboard-overview').classList.add('hidden');
        });

        document.getElementById('show-orders').addEventListener('click', () => {
            document.getElementById('admin-product-management').classList.add('hidden');
            document.getElementById('admin-category-management').classList.add('hidden');
            document.getElementById('admin-order-management').classList.remove('hidden');
            document.getElementById('admin-dashboard-overview').classList.add('hidden');
        });

        document.getElementById('show-dashboard').addEventListener('click', () => {
            document.getElementById('admin-product-management').classList.add('hidden');
            document.getElementById('admin-category-management').classList.add('hidden');
            document.getElementById('admin-order-management').classList.add('hidden');
            document.getElementById('admin-dashboard-overview').classList.remove('hidden');
        });
    </script>


    <header class="header-theme fixed top-0 left-0 w-full z-10 p-4 flex items-center justify-between shadow-md">
        <div class="flex items-center">
            <button id="hamburger-icon" class="hamburger-icon mr-4">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="text-3xl font-bold tracking-tight text-white mr-4">Flourish Boutique</h1>
            <span id="auth-status-message" class="text-sm text-gray-200"></span>
        </div>
        <div class="flex items-center space-x-4">
            <button id="view-cart-btn" class="relative text-white hover:text-gray-200 transition">
                <i class="fas fa-shopping-cart text-2xl"></i>
                <span id="cart-badge" class="absolute -top-2 -right-2 bg-yellow-400 text-gray-900 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
            </button>
            <button id="admin-login-btn" class="btn-secondary hidden sm:inline-flex">Admin Login</button>
            <div id="admin-logout-btn-container" class="hidden">
                <button id="admin-logout-btn" class="btn-secondary">Admin Logout</button>
            </div>
            <button id="shop-now-btn" class="btn-primary" onclick="renderPage('shop')">Shop Now</button>
        </div>
    </header>

    <nav id="hamburger-menu" class="hamburger-menu">
        <button id="menu-close-button" class="menu-close-button">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-white">Categories</h2>
        <ul id="category-list">
            </ul>
        <div class="mt-auto pt-4 border-t border-gray-600">
            <a href="#" onclick="renderPage('shop')" class="block px-4 py-2 text-white font-semibold hover:bg-gray-700 rounded-lg transition-colors">Home</a>
            <a href="#" onclick="showModal('adminLoginModal')" class="block px-4 py-2 text-white font-semibold hover:bg-gray-700 rounded-lg transition-colors mt-2">Admin Login</a>
        </div>
    </nav>

    <main class="container mx-auto p-4 flex-grow">
        <section id="hero-section" class="relative bg-orange-500 text-white py-20 px-6 rounded-3xl shadow-xl flex items-center justify-center text-center overflow-hidden mb-12">
            <img src="https://via.placeholder.com/1500x500/FFDAB9/6347FF?text=Flourish+Boutique+Hero" alt="Hero Background" class="absolute inset-0 w-full h-full object-cover opacity-70">
            <div class="relative z-10">
                <h2 class="text-5xl font-extrabold mb-4 animate-fadeIn">Discover Your Style</h2>
                <p class="text-xl mb-8 animate-fadeIn delay-100">Hand-picked fashion and accessories for every occasion.</p>
                <button class="btn-primary animate-bounce" onclick="document.getElementById('products-section').scrollIntoView({ behavior: 'smooth' })">Explore Products</button>
            </div>
        </section>

        <section id="carousel-section" class="mb-12 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Featured Products</h2>
            <div class="relative">
                <div id="product-carousel" class="flex overflow-x-scroll pb-4 hide-scroll-bar-for-ie-edge-firefox-chrome-safari-opera snap-x snap-mandatory">
                    </div>
                <button id="carousel-prev" class="absolute left-0 top-1/2 -translate-y-1/2 bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 focus:outline-none transition-transform duration-200 z-20">
                    <i class="fas fa-chevron-left text-gray-700"></i>
                </button>
                <button id="carousel-next" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 focus:outline-none transition-transform duration-200 z-20">
                    <i class="fas fa-chevron-right text-gray-700"></i>
                </button>
            </div>
        </section>

        <section id="products-section" class="container mx-auto px-4 py-8 hidden">
            <h2 class="text-4xl font-bold text-center text-gray-800 mb-8">Our Products</h2>

            <div class="flex flex-wrap justify-center gap-3 mb-8">
                <button class="btn-secondary px-5 py-2 rounded-lg text-sm font-medium" onclick="setActiveCategoryFilter('All Products')">All Products</button>
                </div>
            <h3 class="text-2xl font-semibold text-center text-gray-700 mb-8">Category: <span id="current-category-display">All Products</span></h3>

            <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                </div>
        </section>

        <section id="admin-panel" class="container mx-auto p-8 hidden content-card">
            <h2 class="text-4xl font-bold text-center text-gray-800 mb-10">Admin Panel</h2>

            <div class="flex justify-center space-x-4 mb-8">
                <button id="show-dashboard" class="btn-primary">Dashboard</button>
                <button id="show-products" class="btn-primary">Manage Products</button>
                <button id="show-categories" class="btn-primary">Manage Categories</button>
                <button id="show-orders" class="btn-primary">Manage Orders</button>
            </div>

            <div id="admin-dashboard-overview">
                <h3 class="text-3xl font-semibold text-gray-800 mb-6">Dashboard Overview</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-blue-100 p-6 rounded-lg shadow flex items-center justify-between">
                        <div>
                            <p class="text-blue-700 text-lg">Total Products</p>
                            <span id="dashboard-product-count" class="text-4xl font-bold text-blue-900">0</span>
                        </div>
                        <i class="fas fa-box text-5xl text-blue-400"></i>
                    </div>
                    <div class="bg-green-100 p-6 rounded-lg shadow flex items-center justify-between">
                        <div>
                            <p class="text-green-700 text-lg">Total Orders</p>
                            <span id="dashboard-order-count" class="text-4xl font-bold text-green-900">0</span>
                        </div>
                        <i class="fas fa-shopping-bag text-5xl text-green-400"></i>
                    </div>
                </div>
            </div>

            <div id="admin-product-management" class="hidden">
                <h3 class="text-3xl font-semibold text-gray-800 mb-6">Product Management</h3>
                <button class="btn-primary mb-6" onclick="addProduct()">Add New Product</button>
                <div id="admin-product-list" class="space-y-4">
                    </div>
            </div>

            <div id="admin-category-management" class="hidden">
                <h3 class="text-3xl font-semibold text-gray-800 mb-6">Category Management</h3>
                <button class="btn-primary mb-6" onclick="addCategory()">Add New Category</button>
                <div id="admin-category-list" class="space-y-3">
                    </div>
            </div>

            <div id="admin-order-management" class="hidden">
                <h3 class="text-3xl font-semibold text-gray-800 mb-6">Order Management</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="edit-mode-panel" class="container mx-auto p-8 hidden content-card">
            <h2 class="text-4xl font-bold text-center text-gray-800 mb-8">Edit Mode</h2>
            <p class="text-center text-gray-600">This section is for granular editing capabilities. Manage products, categories, and orders from the Admin Panel.</p>
            <button class="btn-secondary block mx-auto mt-8" onclick="renderPage('admin')">Back to Admin Panel</button>
        </section>

    </main>

    <footer class="bg-orange-500 text-white py-8 px-4 mt-12">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 Flourish Boutique. All rights reserved.</p>
            <div class="flex justify-center space-x-6 mt-4">
                <a href="#" class="text-white hover:text-gray-200 transition"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="text-white hover:text-gray-200 transition"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-white hover:text-gray-200 transition"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </footer>

    <div id="adminLoginModal" class="modal-overlay">
        <div class="modal-content-base">
            <button class="close-button" onclick="closeModal('adminLoginModal')">&times;</button>
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Login</h3>
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <label for="admin-password" class="block text-gray-700 text-lg font-medium mb-2">Password</label>
                    <input type="password" id="admin-password" name="admin-password" class="w-full" required>
                </div>
                <button type="submit" class="btn-primary w-full">Login</button>
            </form>
        </div>
    </div>

    <div id="cartModal" class="modal-overlay">
        <div class="modal-content-base max-w-xl w-full">
            <button class="close-button" onclick="closeModal('cartModal')">&times;</button>
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Your Cart (<span id="cart-count">0</span> items)</h3>
            <div id="cart-items" class="max-h-80 overflow-y-auto mb-6 pr-4">
                </div>
            <div class="flex justify-between items-center text-2xl font-bold text-gray-900 border-t pt-4">
                <span>Total:</span>
                <span id="cart-total">$0.00</span>
            </div>
            <button id="checkout-btn" class="btn-primary w-full mt-6">Proceed to Checkout</button>
        </div>
    </div>

    <div id="checkoutModal" class="modal-overlay">
        <div class="modal-content-base max-w-xl w-full">
            <button class="close-button" onclick="closeModal('checkoutModal')">&times;</button>
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Checkout</h3>
            <form id="checkout-form" class="space-y-4">
                <div>
                    <label for="customer-name" class="block text-gray-700 text-sm font-medium mb-1">Full Name</label>
                    <input type="text" id="customer-name" name="customer-name" class="w-full" required>
                </div>
                <div>
                    <label for="customer-email" class="block text-gray-700 text-sm font-medium mb-1">Email</label>
                    <input type="email" id="customer-email" name="customer-email" class="w-full" required>
                </div>
                <div>
                    <label for="customer-address" class="block text-gray-700 text-sm font-medium mb-1">Shipping Address</label>
                    <textarea id="customer-address" name="customer-address" rows="3" class="w-full" required></textarea>
                </div>
                <div>
                    <label for="customer-phone" class="block text-gray-700 text-sm font-medium mb-1">Phone Number</label>
                    <input type="tel" id="customer-phone" name="customer-phone" class="w-full" required>
                </div>
                <button type="submit" class="btn-primary w-full">Place Order</button>
            </form>
        </div>
    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-content-base max-w-2xl w-full">
            <button class="close-button" onclick="closeModal('productModal')">&times;</button>
            <h3 id="product-form-title" class="text-3xl font-bold text-gray-800 mb-6 text-center">Add/Edit Product</h3>
            <form id="product-form" class="space-y-4" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id-field">
                <div>
                    <label for="product-name" class="block text-gray-700 text-sm font-medium mb-1">Product Name</label>
                    <input type="text" id="product-name" class="w-full" required>
                </div>
                <div>
                    <label for="product-description" class="block text-gray-700 text-sm font-medium mb-1">Description</label>
                    <textarea id="product-description" rows="3" class="w-full" required></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="product-price" class="block text-gray-700 text-sm font-medium mb-1">Price ($)</label>
                        <input type="number" id="product-price" step="0.01" min="0.01" class="w-full" required>
                    </div>
                    <div>
                        <label for="product-stock" class="block text-gray-700 text-sm font-medium mb-1">Stock</label>
                        <input type="number" id="product-stock" min="0" class="w-full" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="product-discount-percentage" class="block text-gray-700 text-sm font-medium mb-1">Discount (%)</label>
                        <input type="number" id="product-discount-percentage" min="0" max="100" class="w-full" value="0" required>
                    </div>
                    <div>
                        <label for="product-category" class="block text-gray-700 text-sm font-medium mb-1">Category</label>
                        <select id="product-category" class="w-full" required>
                            </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="product-rating" class="block text-gray-700 text-sm font-medium mb-1">Rating (0-5)</label>
                        <input type="number" id="product-rating" step="0.1" min="0" max="5" class="w-full" value="0" required>
                    </div>
                    <div>
                        <label for="product-reviews" class="block text-gray-700 text-sm font-medium mb-1">Reviews</label>
                        <input type="number" id="product-reviews" min="0" class="w-full" value="0" required>
                    </div>
                    <div>
                        <label for="product-sold" class="block text-gray-700 text-sm font-medium mb-1">Sold Count</label>
                        <input type="number" id="product-sold" min="0" class="w-full" value="0" required>
                    </div>
                </div>
                <div>
                    <label for="product-image" id="image-upload-label" class="block text-gray-700 text-sm font-medium mb-1">Upload Image</label>
                    <input type="file" id="product-image" accept="image/*" class="w-full border p-2 rounded-md">
                    <img id="current-image-preview" src="https://via.placeholder.com/100" alt="Current Image" class="mt-2 w-24 h-24 object-cover rounded-md shadow hidden">
                </div>
                <button type="submit" class="btn-primary w-full">Add Product</button>
            </form>
        </div>
    </div>

    <div id="confirmDeleteProductModal" class="modal-overlay">
        <div class="modal-content-base max-w-sm text-center">
            <button class="close-button" onclick="closeModal('confirmDeleteProductModal')">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete the product "<strong id="product-to-delete-name"></strong>"? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button class="btn-secondary" onclick="closeModal('confirmDeleteProductModal')">Cancel</button>
                <button id="confirm-delete-product-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition" onclick="deleteProductConfirmed()">Yes, Delete</button>
            </div>
        </div>
    </div>


    <div id="categoryModal" class="modal-overlay">
        <div class="modal-content-base max-w-md w-full">
            <button class="close-button" onclick="closeModal('categoryModal')">&times;</button>
            <h3 id="category-form-title" class="text-3xl font-bold text-gray-800 mb-6 text-center">Add/Edit Category</h3>
            <form id="category-form" class="space-y-4" onsubmit="saveCategory(event)">
                <input type="hidden" id="category-id-field">
                <div>
                    <label for="category-name" class="block text-gray-700 text-sm font-medium mb-1">Category Name</label>
                    <input type="text" id="category-name" class="w-full" required>
                </div>
                <button type="submit" class="btn-primary w-full">Add Category</button>
            </form>
        </div>
    </div>

    <div id="confirmDeleteCategoryModal" class="modal-overlay">
        <div class="modal-content-base max-w-sm text-center">
            <button class="close-button" onclick="closeModal('confirmDeleteCategoryModal')">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete the category "<strong id="category-to-delete-name"></strong>"? This will not delete products under this category, but they will become un-categorized.</p>
            <div class="flex justify-center space-x-4">
                <button class="btn-secondary" onclick="closeModal('confirmDeleteCategoryModal')">Cancel</button>
                <button id="confirm-delete-category-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition" onclick="deleteCategoryConfirmed()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal-overlay">
        <div class="modal-content-base max-w-xl w-full">
            <button class="close-button" onclick="closeModal('orderDetailsModal')">&times;</button>
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Order Details</h3>
            <div id="order-details-content" class="space-y-3 text-gray-700">
                </div>
        </div>
    </div>

    <div id="confirmDeleteOrderModal" class="modal-overlay">
        <div class="modal-content-base max-w-sm text-center">
            <button class="close-button" onclick="closeModal('confirmDeleteOrderModal')">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this order? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button class="btn-secondary" onclick="closeModal('confirmDeleteOrderModal')">Cancel</button>
                <button id="confirm-delete-order-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition" onclick="deleteOrderConfirmed()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal-overlay">
        <div class="modal-content-base max-w-sm text-center">
            <button class="close-button" onclick="closeModal('messageModal')">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Notification</h3>
            <p id="messageModalContent" class="text-gray-600 mb-6 text-lg"></p>
        </div>
    </div>

    <div id="imageEnlargeModal" class="modal-overlay">
        <div class="modal-content-base max-w-full max-h-full">
            <button class="close-button" onclick="closeModal('imageEnlargeModal')">&times;</button>
            <img src="" alt="Enlarged Product Image" class="max-w-full max-h-full object-contain">
        </div>
    </div>

    <div id="thankYouMessage" class="thank-you-message">
        <i class="fas fa-check-circle"></i>
        <p>Thank You For Your Order!</p>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[1002] space-y-3">
        </div>

</body>
</html>